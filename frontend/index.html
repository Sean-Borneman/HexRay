<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghidra Binary Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #010409;
            position: relative;
        }

        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .main-panel {
            background-color: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(139, 148, 158, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: box-shadow 0.3s ease;
            position: relative; 
            z-index: 1;
        }
        .main-panel:hover {
            box-shadow: 0 0 40px 5px rgba(59, 130, 246, 0.5);
        }

        #txt-viewer .code-view code {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .drop-zone {
            border: 2px dashed #4B5563;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .drop-zone.dragover {
            background-color: #1F2937;
            border-color: #3B82F6;
        }

        #spinner {
            border-top-color: #3B82F6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .nav-button {
            text-align: left;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .nav-button:hover {
            background-color: rgba(75, 85, 99, 0.5);
        }
        .nav-button.active {
            background-color: #3B82F6;
            color: white;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .action-button {
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }
        .action-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        .action-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .code-view pre {
            height: 40vh;
            overflow: auto;
            background-color: #1E1E1E;
            border: 1px solid rgba(139, 148, 158, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .code-view code {
            white-space: pre;
        }
    </style>
</head>
<body class="text-gray-200">
    
    <canvas id="matrix-canvas"></canvas>

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="main-panel w-full max-w-6xl rounded-xl p-8 space-y-8">
            
            <div>
                <img src="heXray-transparent.png" width="200" height="300" alt="heXray logo" class="mx-auto" />
                <p class="text-center text-gray-400 mt-2">Upload an executable or binary file to begin analysis.</p>
            </div>

            <!-- Step 1: File Upload -->
            <div id="upload-section">
                <form id="upload-form">
                    <label for="file-input" class="cursor-pointer">
                        <div id="drop-zone" class="drop-zone rounded-lg p-10 text-center">
                             <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                            <p class="mt-4 text-lg text-gray-300"><span class="font-semibold text-blue-400">Click to upload</span> or drag and drop</p>
                            <p id="file-name-display" class="mt-2 text-sm text-gray-500">No file selected</p>
                            <input type="file" id="file-input" name="uploadedFile" class="hidden">
                        </div>
                    </label>
                </form>
            </div>

            <!-- Step 2: Analysis Control -->
            <div id="analysis-section" class="hidden text-center space-y-4">
                <div class="bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-gray-400">File ready for analysis:</p>
                    <p id="ready-file-name" class="font-semibold text-white text-lg"></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <button id="analyze-btn" class="action-button w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">Analyze Only</button>
                  <button id="autohack-btn" class="action-button w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg">Analyze + Auto Hack</button>
                </div>
            </div>

            <!-- Auto Hack Flag Format Confirmation -->
            <div id="flag-config" class="hidden text-left space-y-4 bg-gray-800/60 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-white">Auto Hack Configuration</h3>
                <p class="text-gray-400 text-sm">Provide the expected flag format (regex). This helps the exploit detect success quickly.</p>
                <label for="flag-regex" class="block text-gray-300">Flag Format (regex)</label>
                <input id="flag-regex" type="text" class="w-full rounded-md bg-gray-900 border border-gray-600 text-gray-100 p-2"
                       placeholder="FortID{[^}]+}" value="FortID{[^}]+}">
                <label class="inline-flex items-center space-x-2 text-gray-300">
                    <input id="flag-accept" type="checkbox" class="rounded bg-gray-900 border-gray-600">
                    <span>I confirm the flag format above is correct.</span>
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                    <button id="start-autohack-btn" disabled class="action-button w-full bg-purple-600 disabled:bg-purple-900 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg">Start Auto Hack</button>
                    <button id="cancel-autohack-btn" class="action-button w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Cancel</button>
                </div>
            </div>

            <!-- Status & Results -->
            <div id="status-section" class="text-center space-y-4 hidden">
                 <div class="flex items-center justify-center space-x-3">
                    <div id="spinner" class="w-8 h-8 border-4 border-gray-600 rounded-full"></div>
                    <p id="status-message" class="text-lg font-medium text-gray-300">Uploading file...</p>
                </div>
            </div>
            
            <div id="results-container" class="hidden space-y-8">
                <!-- Downloadable files -->
                <div id="results-section">
                     <h2 class="text-xl font-semibold text-white mb-4">Downloadable Files</h2>
                     <ul id="results-list" class="space-y-3"></ul>
                </div>

                <!-- Viewable Files Split View -->
                <div id="viewers-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- C Code Viewer -->
                    <div id="c-viewer" class="hidden">
                        <h2 class="text-xl font-semibold text-white mb-4">Decompiled Code (.c)</h2>
                        <div class="bg-gray-900/70 p-4 rounded-lg space-y-4">
                            <nav><ul id="c-nav" class="space-y-2"></ul></nav>
                            <main class="code-view"><pre><code id="c-content" class="language-c">Select a file to view...</code></pre></main>
                        </div>
                    </div>
                    <!-- TXT File Viewer -->
                    <div id="txt-viewer" class="hidden">
                        <h2 class="text-xl font-semibold text-white mb-4">Text Reports (.txt)</h2>
                        <div class="bg-gray-900/70 p-4 rounded-lg space-y-4">
                            <nav><ul id="txt-nav" class="space-y-2"></ul></nav>
                            <main class="code-view"><pre><code id="txt-content" class="language-plaintext">Select a file to view...</code></pre></main>
                        </div>
                    </div>
                </div>

                <button id="reset-btn" class="action-button mt-6 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Analyze Another File</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('matrix-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const fontSize = 16;
            const columns = canvas.width / fontSize;
            const drops = Array(Math.floor(columns)).fill(1);

            function draw() {
                ctx.fillStyle = 'rgba(1, 4, 9, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#00FF41';
                ctx.font = `${fontSize}px monospace`;
                for (let i = 0; i < drops.length; i++) {
                    const text = characters.charAt(Math.floor(Math.random() * characters.length));
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            }
            let drawInterval = setInterval(draw, 33);
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const newColumns = canvas.width / fontSize;
                while(drops.length < newColumns) drops.push(1);
                while(drops.length > newColumns) drops.pop();
            });
        });

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const analyzeBtn = document.getElementById('analyze-btn');
        const autoHackBtn = document.getElementById('autohack-btn');
        const flagConfig = document.getElementById('flag-config');
        const flagRegexInput = document.getElementById('flag-regex');
        const flagAccept = document.getElementById('flag-accept');
        const startAutohackBtn = document.getElementById('start-autohack-btn');
        const cancelAutohackBtn = document.getElementById('cancel-autohack-btn');
        const readyFileName = document.getElementById('ready-file-name');
        const uploadSection = document.getElementById('upload-section');
        const analysisSection = document.getElementById('analysis-section');
        const statusSection = document.getElementById('status-section');
        const statusMessage = document.getElementById('status-message');
        const resultsContainer = document.getElementById('results-container');
        const resultsList = document.getElementById('results-list');
        const resetBtn = document.getElementById('reset-btn');
        const cViewer = document.getElementById('c-viewer');
        const cNav = document.getElementById('c-nav');
        const cContent = document.getElementById('c-content');
        const txtViewer = document.getElementById('txt-viewer');
        const txtNav = document.getElementById('txt-nav');
        const txtContent = document.getElementById('txt-content');
        
        let uploadedFileName = null;

        // --- Event Listeners ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', () => { if (fileInput.files.length > 0) handleFile(fileInput.files[0]); });
        analyzeBtn.addEventListener('click', () => runAnalysis(false));
        autoHackBtn.addEventListener('click', () => {
            // Show confirmation panel for flag format
            flagConfig.classList.remove('hidden');
        });
        flagAccept.addEventListener('change', () => {
            startAutohackBtn.disabled = !flagAccept.checked;
        });
        startAutohackBtn.addEventListener('click', () => {
            flagConfig.classList.add('hidden');
            runAnalysis(true);
        });
        cancelAutohackBtn.addEventListener('click', () => {
            flagConfig.classList.add('hidden');
        });
        resetBtn.addEventListener('click', resetUI);

        // --- Core Functions ---
        async function handleFile(file) {
            fileNameDisplay.textContent = file.name;
            uploadSection.classList.add('hidden');
            analysisSection.classList.add('hidden');
            statusSection.classList.remove('hidden');
            statusMessage.textContent = `Uploading ${file.name}...`;
            const formData = new FormData();
            formData.append('uploadedFile', file);
            try {
                const response = await fetch('http://localhost:3000/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Upload failed: ${response.statusText}`);
                const result = await response.json();
                uploadedFileName = result.fileName;
                statusSection.classList.add('hidden');
                readyFileName.textContent = file.name;
                analysisSection.classList.remove('hidden');
            } catch (error) {
                showError(`Upload Error: ${error.message}`);
            }
        }
        
        async function runAnalysis(autoHack) {
            if (!uploadedFileName) return;
            analysisSection.classList.add('hidden');
            statusSection.classList.remove('hidden');
            statusMessage.textContent = `Analyzing ${readyFileName.textContent}${autoHack ? ' (with Auto Hack)' : ''}... Please wait.`;
            try {
                const flagRegex = autoHack ? ((flagRegexInput && flagRegexInput.value) || '').trim() : '';
                const analyzeResponse = await fetch('http://localhost:3000/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileName: uploadedFileName, autoHack: !!autoHack, flagRegex })
                });
                if (!analyzeResponse.ok) throw new Error(`Analysis failed: ${analyzeResponse.statusText}`);
                const analyzeResult = await analyzeResponse.json();
                statusSection.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                displayDownloadResults(analyzeResult.results);
                await fetchAndDisplayViewableFiles();
            } catch (error) {
                showError(`Analysis Error: ${error.message}`);
            }
        }

        async function fetchAndDisplayViewableFiles() {
            try {
                const response = await fetch('http://localhost:3000/code-results');
                if (!response.ok) throw new Error('Could not fetch viewable files.');
                const data = await response.json();

                if (data.cFiles && data.cFiles.length > 0) {
                    cViewer.classList.remove('hidden');
                    populateViewer(data.cFiles, cNav, cContent, 'c');
                }
                if (data.txtFiles && data.txtFiles.length > 0) {
                    txtViewer.classList.remove('hidden');
                    populateViewer(data.txtFiles, txtNav, txtContent, 'txt');
                }
            } catch (error) {
                console.error("File Display Error:", error);
            }
        }

        function populateViewer(files, navElement, contentElement, type) {
            navElement.innerHTML = '';
            files.forEach((file) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = file.fileName;
                button.title = file.fileName;
                button.className = 'nav-button w-full';
                button.onclick = () => {
                    navElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    if (type === 'c') {
                        const highlighted = hljs.highlight(file.content, { language: 'c', ignoreIllegals: true });
                        contentElement.innerHTML = highlighted.value;
                    } else {
                        contentElement.textContent = file.content;
                    }
                };
                li.appendChild(button);
                navElement.appendChild(li);
            });
            if (navElement.firstChild) navElement.querySelector('button').click();
        }

        function displayDownloadResults(resultFiles) {
            resultsList.innerHTML = '';
            if (resultFiles && resultFiles.length > 0) {
                 resultFiles.forEach(fileName => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-700/50 p-3 rounded-lg flex justify-between items-center';
                    li.innerHTML = `<span class="text-gray-300">${fileName}</span><a href="http://localhost:3000/results/${fileName}" download class="action-button bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-md text-sm">Download</a>`;
                    resultsList.appendChild(li);
                });
            } else {
                 resultsList.innerHTML = '<li class="text-gray-400">No result files were generated.</li>';
            }
        }

        function showError(message) {
            statusSection.classList.remove('hidden');
            statusMessage.textContent = message;
            statusMessage.classList.add('text-red-400');
        }

        async function resetUI() {
            try {
                const response = await fetch('http://localhost:3000/cleanup', { method: 'POST' });
                if (response.ok) console.log((await response.json()).message);
            } catch (error) {
                console.error('Error during cleanup:', error);
            }
            uploadedFileName = null;
            fileInput.value = '';
            fileNameDisplay.textContent = 'No file selected';
            uploadSection.classList.remove('hidden');
            analysisSection.classList.add('hidden');
            statusSection.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            cViewer.classList.add('hidden');
            txtViewer.classList.add('hidden');
            cContent.textContent = 'Select a file to view...';
            txtContent.textContent = 'Select a file to view...';
            statusMessage.textContent = 'Uploading...';
            statusMessage.classList.remove('text-red-400');
        }
    </script>
</body>
</html>

